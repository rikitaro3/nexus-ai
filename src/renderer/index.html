<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;">
  <title>Nexus</title>
  <link rel="stylesheet" href="styles/app.css">
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI','Roboto','Helvetica','Arial',sans-serif; }
  </style>
  </head>
<body>
  <div class="container" data-testid="app-shell__container">
    <header class="app-header" data-testid="app-shell__header">
      <div class="app-header__main">
        <div class="app-brand" data-testid="app-shell__brand">
          <h1 data-testid="app-shell__title">Nexus</h1>
          <p class="app-subtitle" data-testid="app-shell__subtitle">Docs / Tasks workspace</p>
        </div>
        <div class="app-header__actions">
          <button
            id="download-console"
            class="btn btn-ghost"
            data-testid="app-shell__download-console-button"
          >📋 Console Logをダウンロード</button>
        </div>
      </div>
    </header>
    <nav class="tabs" data-testid="app-shell__tabs">
      <button
        class="tab-btn active"
        data-tab="docs"
        data-testid="app-shell__tab-docs"
      >Docs</button>
      <button
        class="tab-btn"
        data-tab="tasks"
        data-testid="app-shell__tab-tasks"
      >Tasks</button>
      <button
        class="tab-btn"
        data-tab="settings"
        data-testid="app-shell__tab-settings"
      >Settings</button>
    </nav>
    <main data-testid="app-shell__main">
      <div id="docs" class="tab-content active" data-testid="docs-navigator__panel">
        <section class="card" data-testid="docs-navigator__section">
          <h2 data-testid="docs-navigator__heading">📚 Docs Navigator</h2>
          <div class="control-group hidden" id="context-select-wrap" data-testid="docs-navigator__context-select-group">
            <label for="context-select" data-testid="docs-navigator__context-select-label">Context:</label>
            <select
              id="context-select"
              title="Context source"
              data-testid="docs-navigator__context-select"
            >
              <option value="repo">Repo</option>
              <option value="nexus">Nexus</option>
            </select>
          </div>
          <div class="docs-mode-bar" role="toolbar" data-testid="docs-navigator__mode-toolbar">
            <div class="docs-mode-buttons" data-testid="docs-navigator__mode-buttons">
              <button
                class="btn btn-secondary docs-mode-btn"
                data-mode="docs"
                data-testid="docs-navigator__mode-docs-button"
              >Docs</button>
              <button
                class="btn btn-secondary docs-mode-btn"
                data-mode="feats"
                data-testid="docs-navigator__mode-feats-button"
              >FEATs</button>
              <button
                class="btn btn-secondary docs-mode-btn active"
                data-mode="tree"
                data-testid="docs-navigator__mode-tree-button"
              >Tree</button>
            </div>
            <div class="docs-mode-meta" data-testid="docs-navigator__mode-description-wrap">
              <span id="docs-mode-description" data-testid="docs-navigator__mode-description">Breadcrumbsからリンク構造を検証します</span>
            </div>
          </div>
          <div id="docs-mode-docs" class="docs-mode" data-testid="docs-navigator__mode-docs">
            <div class="docs-split" data-testid="docs-navigator__docs-split">
              <div class="docs-left" data-testid="docs-navigator__category-column">
                <h3 data-testid="docs-navigator__category-heading">カテゴリ</h3>
                <ul id="docs-categories" data-testid="docs-navigator__category-list"></ul>
                <p class="empty-state" id="docs-categories-empty" data-testid="docs-navigator__category-empty">カテゴリを読み込み中です...</p>
              </div>
              <div class="docs-middle" data-testid="docs-navigator__docs-column">
                <h3 data-testid="docs-navigator__docs-heading">ドキュメント</h3>
                <ul id="docs-list" data-testid="docs-navigator__docs-list"></ul>
                <p class="empty-state" id="docs-list-empty" data-testid="docs-navigator__docs-empty">カテゴリを選択してください</p>
              </div>
              <div class="docs-right" data-testid="docs-navigator__detail-column">
                <h3 data-testid="docs-navigator__detail-heading">詳細</h3>
                <div id="docs-detail" class="empty-state" data-testid="docs-navigator__detail-panel">ドキュメントを選択すると詳細が表示されます</div>
              </div>
            </div>
          </div>
          <div id="docs-mode-feats" class="docs-mode" data-testid="docs-navigator__mode-feats">
            <div class="feats-toolbar" data-testid="docs-navigator__feats-toolbar">
              <input
                id="feat-search"
                type="text"
                placeholder="FEAT-IDやタイトルを検索"
                data-testid="docs-navigator__feat-search"
              >
              <span id="feat-dup-alert" class="status hidden" data-testid="docs-navigator__feat-dup-alert"></span>
            </div>
            <div class="docs-split" data-testid="docs-navigator__feats-split">
              <div class="docs-left" data-testid="docs-navigator__feats-column">
                <h3 data-testid="docs-navigator__feats-heading">FEATs</h3>
                <ul id="feats-list" data-testid="docs-navigator__feats-list"></ul>
                <p class="empty-state" id="feats-list-empty" data-testid="docs-navigator__feats-empty">FEAT一覧を読み込み中...</p>
              </div>
              <div class="docs-right span-2" data-testid="docs-navigator__feat-detail-column">
                <h3 data-testid="docs-navigator__feat-detail-heading">詳細</h3>
                <div id="feat-detail" class="empty-state" data-testid="docs-navigator__feat-detail">FEATを選択してください</div>
              </div>
            </div>
          </div>
          <div id="docs-mode-tree" class="docs-mode active" data-testid="docs-navigator__mode-tree">
            <div class="feats-toolbar" data-testid="docs-navigator__tree-toolbar">
              <select
                id="tree-direction"
                title="Tree direction"
                data-testid="docs-navigator__tree-direction-select"
              >
                <option value="downstream">Downstream (上位→下位)</option>
                <option value="upstream">Upstream (下位→上位)</option>
              </select>
              <button
                id="tree-validate"
                class="btn btn-primary"
                data-testid="docs-navigator__tree-validate-button"
              >Validate Gates</button>
              <span
                id="tree-status"
                class="status status-info"
                aria-live="polite"
                data-testid="docs-navigator__tree-status"
              ></span>
            </div>
            <div class="docs-split" data-testid="docs-navigator__tree-split">
              <div class="docs-left" data-testid="docs-navigator__tree-column">
                <h3 data-testid="docs-navigator__tree-heading">Tree</h3>
                <div id="tree-view" class="empty-state" data-testid="docs-navigator__tree-view">Treeを読み込み中です...</div>
              </div>
              <div class="docs-right span-2" data-testid="docs-navigator__tree-detail-column">
                <h3 data-testid="docs-navigator__tree-detail-heading">詳細</h3>
                <div id="tree-detail" class="empty-state" data-testid="docs-navigator__tree-detail">ノードを選択するとリンクが表示されます</div>
                <hr/>
                <h3 data-testid="docs-navigator__gate-heading">Quality Gates</h3>
                <div id="gate-results" class="empty-state" data-testid="docs-navigator__gate-results">Validateを押してGate結果を確認しましょう</div>
              </div>
            </div>
          </div>
        </section>
      </div>
      <div id="tasks" class="tab-content" data-testid="tasks__panel">
        <section class="card" data-testid="tasks__section">
          <h2 data-testid="tasks__heading">🗒️ Tasks</h2>
          <div class="tasks-toolbar" data-testid="tasks__toolbar">
            <button id="tasks-save" class="btn btn-primary" data-testid="tasks__save-button">Save</button>
            <button id="tasks-export" class="btn btn-secondary" data-testid="tasks__export-button">Export to human_todo.mdc</button>
            <input
              id="tasks-filter"
              type="text"
              placeholder="キーワード/FEAT-ID/カテゴリでフィルタ"
              data-testid="tasks__filter-input"
            >
          </div>
          <div class="tasks-recommendations" id="tasks-recommendations" data-testid="tasks__recommendations">
            <div class="tasks-recommendations__header" data-testid="tasks__recommendations-header">
              <h3 data-testid="tasks__recommendations-heading">推奨アクション</h3>
              <div class="tasks-recommendations__actions" data-testid="tasks__recommendations-actions">
                <button
                  id="tasks-recommendations-refresh"
                  class="btn btn-secondary btn-sm"
                  data-testid="tasks__recommendations-refresh-button"
                >再計算</button>
              </div>
            </div>
            <p
              class="tasks-recommendations__status"
              id="tasks-recommendations-status"
              data-testid="tasks__recommendations-status"
            >解析準備中...</p>
            <ul
              class="tasks-recommendations__list"
              id="tasks-recommendations-list"
              data-testid="tasks__recommendations-list"
            ></ul>
          </div>
          <div class="tasks-inputs" data-testid="tasks__inputs">
            <div class="form-group" data-testid="tasks__bulk-group">
              <label for="tasks-bulk" data-testid="tasks__bulk-label">複数行貼り付け（1行=1件、例: 【機能改善】タイトル）</label>
              <textarea id="tasks-bulk" rows="4" data-testid="tasks__bulk-textarea"></textarea>
            </div>
            <div class="control-group" data-testid="tasks__bulk-actions">
              <button id="tasks-bulk-import" class="btn btn-primary" data-testid="tasks__bulk-import-button">取り込み</button>
            </div>
            <hr/>
            <div class="form-group" data-testid="tasks__single-add-group">
              <label data-testid="tasks__single-add-label">単一追加</label>
              <div class="control-group" data-testid="tasks__single-add-controls">
                <input
                  id="tasks-add-category"
                  type="text"
                  placeholder="カテゴリ"
                  data-testid="tasks__single-add-category-input"
                >
                <input
                  id="tasks-add-title"
                  type="text"
                  placeholder="タイトル"
                  data-testid="tasks__single-add-title-input"
                >
                <button
                  id="tasks-add-one"
                  class="btn btn-secondary"
                  data-testid="tasks__single-add-button"
                >追加</button>
              </div>
            </div>
          </div>
          <div class="docs-split" data-testid="tasks__split">
            <div class="docs-left" data-testid="tasks__category-column">
              <h3 data-testid="tasks__category-heading">カテゴリ</h3>
              <ul id="tasks-categories" data-testid="tasks__category-list"></ul>
              <p class="empty-state" id="tasks-categories-empty" data-testid="tasks__category-empty">タスクを追加するとカテゴリが表示されます</p>
            </div>
            <div class="docs-middle" data-testid="tasks__list-column">
              <h3 data-testid="tasks__list-heading">一覧</h3>
              <ul id="tasks-list" data-testid="tasks__list"></ul>
              <p class="empty-state" id="tasks-list-empty" data-testid="tasks__list-empty">タスクがありません。上のフォームから追加してください。</p>
            </div>
            <div class="docs-right" data-testid="tasks__detail-column">
              <h3 data-testid="tasks__detail-heading">詳細</h3>
              <div id="task-detail" class="empty-state" data-testid="tasks__detail-panel">タスクを選択すると編集できます</div>
            </div>
          </div>
        </section>
      </div>
      <div id="settings" class="tab-content" data-testid="settings__panel">
        <section class="card" data-testid="settings__section">
          <h2 data-testid="settings__heading">⚙️ Settings</h2>
          <div class="settings-section" data-testid="settings__project-root-section">
            <h3 data-testid="settings__project-root-heading">プロェクトルート</h3>
            <div class="form-group" data-testid="settings__project-root-group">
              <label for="settings-project-root" data-testid="settings__project-root-label">Project Root Path</label>
              <input
                id="settings-project-root"
                type="text"
                placeholder="/path/to/project"
                data-testid="settings__project-root-input"
              />
            </div>
            <div class="control-group" data-testid="settings__project-root-actions">
              <button
                id="settings-save-root"
                class="btn btn-primary"
                data-testid="settings__save-project-root-button"
              >Save Project Root</button>
              <button
                id="settings-test-root"
                class="btn btn-secondary"
                data-testid="settings__test-project-root-button"
              >Test Path</button>
              <span
                id="settings-project-root-status"
                class="status hidden"
                data-testid="settings__project-root-status"
              ></span>
            </div>
            <div id="settings-test-results" class="settings-test-results" data-testid="settings__test-results"></div>
          </div>
          <hr />
          <div class="settings-section" data-testid="settings__ai-provider-section">
            <h3 data-testid="settings__ai-provider-heading">AI Provider</h3>
            <div class="form-group" data-testid="settings__ai-provider-group">
              <label for="settings-ai-provider" data-testid="settings__ai-provider-label">Breakdown Provider</label>
              <select id="settings-ai-provider" data-testid="settings__ai-provider-select"></select>
            </div>
            <p id="settings-ai-provider-description" class="text-muted" data-testid="settings__ai-provider-description">利用するAIプロバイダーを選択してください。</p>
            <div class="control-group" data-testid="settings__ai-provider-actions">
              <span id="settings-ai-provider-status" class="status hidden" data-testid="settings__ai-provider-status"></span>
            </div>
          </div>
          <hr />
          <div class="settings-section" data-testid="settings__context-section">
            <h3 data-testid="settings__context-heading">Context File</h3>
            <p id="settings-context-path" class="settings-context-path" data-testid="settings__context-path">(未設定)</p>
            <div class="control-group" data-testid="settings__context-actions">
              <button
                id="settings-select-context"
                class="btn btn-secondary"
                data-testid="settings__select-context-button"
              >Select Context File</button>
              <button
                id="settings-clear-context"
                class="btn btn-secondary"
                data-testid="settings__clear-context-button"
              >Clear</button>
              <span id="settings-context-status" class="status hidden" data-testid="settings__context-status"></span>
            </div>
            <p class="text-muted">変更後はDocsタブを再読み込みしてください（ツールを再起動すると確実です）。</p>
          </div>
          <hr />
          <div class="settings-section" data-testid="settings__theme-section">
            <h3 data-testid="settings__theme-heading">テーマ</h3>
            <div class="control-group" data-testid="settings__theme-actions">
              <button
                id="settings-toggle-theme"
                class="btn btn-secondary"
                data-testid="settings__toggle-theme-button"
              >🌙 ダークモードに切り替え</button>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>
  <script>
    // Global error handler: log all errors to console instead of showing popup
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('[Global Error Handler]', {
        message: message,
        source: source,
        line: lineno,
        col: colno,
        error: error,
        stack: error ? error.stack : 'N/A'
      });
      return true; // Prevent default error popup
    };

    window.addEventListener('unhandledrejection', function(event) {
      console.error('[Unhandled Promise Rejection]', event.reason);
    });
  </script>
  <script src="services/ai/registry.js"></script>
  <script src="services/ai/providers/cursor.js"></script>
  <script src="shared/app.js"></script>
  <script src="features/docs-navigator/docs-navigator.js"></script>
  <script src="features/tasks/tasks.js"></script>
  <script src="features/settings/settings.js"></script>
</body>
</html>
